apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: commit-stage-template
spec:
  arguments:
    parameters:
      - name: repo-owner
      - name: repo-name
      - name: git-commit
      - name: github-token
      - name: repo-url
  templates:
    - name: backend
      dag:
        tasks:
          - name: install-dependencies
            template: install-dependencies

          - name: test
            template: run-unit-tests
            dependencies: [install-dependencies]

          - name: build
            template: build-app
            dependencies: [install-dependencies]

          - name: create-artifact
            template: create-artifact
            dependencies: [build, test]
            arguments:
              parameters:
                - name: repo-owner
                  value: "{{workflow.parameters.repo-owner}}"
                - name: repo-name
                  value: "{{workflow.parameters.repo-name}}"
                - name: repo-url
                  value: "{{workflow.parameters.repo-url}}"
                - name: git-commit
                  value: "{{workflow.parameters.git-commit}}"
                - name: github-token
                  value: "{{workflow.parameters.github-token}}"
    - name: frontend
      dag:
        tasks:
          - name: clone-repo
            template: clone-repo

          - name: install-node-dependencies
            template: install-node-dependencies
            dependencies: [clone-repo]

          - name: test
            template: run-node-unit-tests
            dependencies: [install-node-dependencies]

          - name: build
            template: build-node-app
            dependencies: [install-node-dependencies]

          - name: create-artifact
            template: create-node-artifact
            dependencies: [build, test]
            arguments:
              parameters:
                - name: repo-owner
                  value: "{{workflow.parameters.repo-owner}}"
                - name: repo-name
                  value: "{{workflow.parameters.repo-name}}"
                - name: repo-url
                  value: "{{workflow.parameters.repo-url}}"
                - name: git-commit
                  value: "{{workflow.parameters.git-commit}}"
                - name: github-token
                  value: "{{workflow.parameters.github-token}}"

    - name: clone-repo
      container:
        image: alpine/git
        command: [sh, -c]
        env:
          - name: GITHUB_TOKEN
            valueFrom:
              secretKeyRef:
                name: github-pat
                namespace: argo-events
                key: token
        volumeMounts:
          - name: repo
            mountPath: /src
        args:
          - |
            pwd

            echo "Kollar om repo redan finns..."
            cd /src
            pwd
            ls
            echo "ls -----------------"

            if [ -d "{{workflow.parameters.repo-name}}" ]; then
                echo "Repo finns redan, kör git pull..."
                cd {{workflow.parameters.repo-name}}
                git pull origin main --rebase  # eller din default branch
                cd ..
            else
                echo "Klonar GitHub-repo..."
                git clone https://$GITHUB_TOKEN@{{workflow.parameters.repo-url}} {{workflow.parameters.repo-name}}
            fi
            pwd
            ls
            echo "ls-----------------"

    - name: install-node-dependencies
      container:
        image: oven/bun:latest
        volumeMounts:
          - name: repo
            mountPath: /src
        command: [sh, -c]
        workingDir: /src/plan/frontend
        args:
          - |
            ls -a
            bun install
            echo "Kör bun install"

    - name: build-node-app
      container:
        image: oven/bun:latest
        volumeMounts:
          - name: repo
            mountPath: /src
        workingDir: /src/plan/frontend
        command: [sh, -c]
        args:
          - |
            pwd
            echo "pwd -----------------------------------"
            ls 
            echo "ls -----------------------------------"
            echo "Bygger applikationen..."
            bun run build

    - name: run-node-unit-tests
      container:
        image: node:lts
        volumeMounts:
          - name: repo
            mountPath: /src
        workingDir: /src/plan/frontend
        command: [sh, -c]
        args:
          - |
            pwd
            echo "pwd -----------------------------------"
            ls
            echo "ls-----------------"
            echo "Kör unit tests..."
            npm run test

    - name: create-node-artifact
      inputs:
        parameters:
          - name: repo-owner
          - name: repo-name
          - name: git-commit
          - name: github-token
      container:
        image: docker:20
        volumeMounts:
          - name: repo
            mountPath: /src
        workingDir: /src/frontend
        command: [sh, -c]
        args:
          - |
            echo "Skapar image och pushar till GitHub Container Registry..."
            docker build -t ghcr.io/{{inputs.parameters.repo-owner}}/{{inputs.parameters.repo-name}}:{{inputs.parameters.git-commit}} .
            echo {{inputs.parameters.github-token}} | docker login ghcr.io -u {{inputs.parameters.repo-owner}} --password-stdin
            docker push ghcr.io/{{inputs.parameters.repo-owner}}/{{inputs.parameters.repo-name}}:{{inputs.parameters.git-commit}}
